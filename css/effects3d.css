/* ═══════════════════════════════════════════════════════════════════
   芒果庄园 — 3D Effects & Premium Visual Upgrade
   Perspective board, particle explosions, screen shake, depth
   ═══════════════════════════════════════════════════════════════════ */

/* ── 3D Board Perspective ── */
/* NOTE: preserve-3d + perspective breaks touch events on iOS Safari (WebKit bug)
   Use flat transforms only — visual depth via shadows/gradients instead */
.game-board-container {
  /* perspective removed — iOS touch fix */
}

#game-board {
  /* No 3D transforms — iOS Safari touch events require flat layout */
  transition: transform 0.3s cubic-bezier(.25,.46,.45,.94) !important;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05) !important;
}

/* Subtle board tilt on interaction — 2D scale only (iOS safe) */
#game-board.tilt-left  { transform: scale(0.995) !important; }
#game-board.tilt-right { transform: scale(0.995) !important; }
#game-board.tilt-up    { transform: scale(1.005) !important; }
#game-board.tilt-down  { transform: scale(0.99) !important; }

/* Board depth shadow */
#game-board::after {
  content: '';
  position: absolute;
  bottom: -8px; left: 5%; right: 5%;
  height: 16px;
  background: radial-gradient(ellipse, rgba(0,0,0,0.3) 0%, transparent 70%);
  filter: blur(6px);
  z-index: -1;
  pointer-events: none;
}

/* ── Gem Depth (flat, iOS safe) ── */
.gem {
  /* No preserve-3d — breaks iOS touch */
  backface-visibility: hidden !important;
}

/* Gem active lift — 2D only */
.gem:active {
  transform: scale(1.1) !important;
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.5)) brightness(1.15) !important;
}

/* ── Match Explosion Particles ── */
@keyframes matchExplode {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.8); opacity: 0.6; }
  100% { transform: scale(2.5); opacity: 0; }
}

@keyframes matchRing {
  0% { transform: scale(0.5); opacity: 0.8; border-width: 3px; }
  100% { transform: scale(2.5); opacity: 0; border-width: 0.5px; }
}

.gem.matching {
  animation: matchFlash 0.4s ease-out !important;
  z-index: 10 !important;
}

@keyframes matchFlash {
  0% { transform: scale(1); filter: brightness(1); }
  30% { transform: scale(1.3); filter: brightness(2) drop-shadow(0 0 15px currentColor); }
  60% { transform: scale(0.8); filter: brightness(1.5); }
  100% { transform: scale(0) rotate(180deg); filter: brightness(3); opacity: 0; }
}

/* Gem fall-in bounce */
.gem.dropping {
  animation: gemDrop 0.35s cubic-bezier(.34,1.56,.64,1) !important;
}

@keyframes gemDrop {
  0% { transform: translateY(-60px) scale(0.6); opacity: 0; }
  60% { transform: translateY(4px) scale(1.05); opacity: 1; }
  80% { transform: translateY(-2px) scale(0.98); }
  100% { transform: translateY(0) scale(1); }
}

/* ── Screen Shake ── */
@keyframes boardShake {
  0%, 100% { transform: rotateX(2deg) translate(0,0); }
  10% { transform: rotateX(2deg) translate(-3px, 2px); }
  20% { transform: rotateX(2deg) translate(3px, -2px); }
  30% { transform: rotateX(2deg) translate(-2px, 1px); }
  40% { transform: rotateX(2deg) translate(2px, -1px); }
  50% { transform: rotateX(2deg) translate(-1px, 1px); }
}

@keyframes boardShakeHeavy {
  0%, 100% { transform: rotateX(2deg) translate(0,0); }
  10% { transform: rotateX(3deg) translate(-6px, 4px) rotate(-0.5deg); }
  20% { transform: rotateX(1deg) translate(6px, -4px) rotate(0.5deg); }
  30% { transform: rotateX(3deg) translate(-4px, 2px) rotate(-0.3deg); }
  40% { transform: rotateX(1deg) translate(4px, -2px) rotate(0.3deg); }
  50% { transform: rotateX(2deg) translate(-2px, 1px); }
}

#game-board.shake {
  animation: boardShake 0.3s ease-out !important;
}

#game-board.shake-heavy {
  animation: boardShakeHeavy 0.5s ease-out !important;
}

/* ── Combo Counter 3D ── */
.combo-display {
  transform-style: preserve-3d;
  animation: comboPopIn 0.4s cubic-bezier(.34,1.56,.64,1);
  text-shadow: 
    0 2px 4px rgba(0,0,0,0.5),
    0 0 20px currentColor;
}

@keyframes comboPopIn {
  0% { transform: scale(0) rotateY(-90deg); opacity: 0; }
  60% { transform: scale(1.2) rotateY(10deg); opacity: 1; }
  100% { transform: scale(1) rotateY(0); }
}

/* ── Score Popup 3D ── */
.score-popup {
  animation: scoreFloat 1s ease-out forwards !important;
  font-weight: 800 !important;
  text-shadow: 0 2px 8px rgba(0,0,0,0.5), 0 0 20px currentColor !important;
  pointer-events: none !important;
}

@keyframes scoreFloat {
  0% { transform: translateY(0) scale(0.5) rotateX(30deg); opacity: 0; }
  20% { transform: translateY(-10px) scale(1.2) rotateX(0); opacity: 1; }
  100% { transform: translateY(-50px) scale(0.8); opacity: 0; }
}

/* ── Special Gem 3D Glow ── */
.gem.special.row-blast,
.gem.special.col-blast {
  animation: specialPulse 1.5s ease-in-out infinite !important;
}

@keyframes specialPulse {
  0%, 100% { 
    filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5)) drop-shadow(0 0 8px rgba(255,215,0,0.3)) !important; 
  }
  50% { 
    filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5)) drop-shadow(0 0 20px rgba(255,215,0,0.6)) !important; 
  }
}

.gem.special.bomb {
  animation: bombPulse 1s ease-in-out infinite !important;
}

@keyframes bombPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.08) rotate(3deg); }
}

.gem.special.rainbow {
  animation: rainbowShimmer 2s linear infinite !important;
}

@keyframes rainbowShimmer {
  0% { filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5)) hue-rotate(0deg) brightness(1.1); }
  50% { filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5)) hue-rotate(180deg) brightness(1.3); }
  100% { filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5)) hue-rotate(360deg) brightness(1.1); }
}

/* ── Level Complete Celebration ── */
@keyframes victoryBurst {
  0% { transform: scale(0) rotate(-180deg); opacity: 0; }
  50% { transform: scale(1.3) rotate(10deg); opacity: 1; }
  70% { transform: scale(0.95) rotate(-3deg); }
  100% { transform: scale(1) rotate(0); }
}

.level-complete-overlay {
  animation: victoryBurst 0.6s cubic-bezier(.34,1.56,.64,1) !important;
}

/* ── Ambient Background Particles ── */
.game-screen::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: 
    radial-gradient(2px 2px at 20% 30%, rgba(168,85,247,0.15) 0%, transparent 100%),
    radial-gradient(2px 2px at 80% 70%, rgba(249,115,22,0.12) 0%, transparent 100%),
    radial-gradient(2px 2px at 50% 50%, rgba(34,197,94,0.1) 0%, transparent 100%);
  animation: ambientDrift 15s ease-in-out infinite;
  pointer-events: none;
  z-index: 0;
}

@keyframes ambientDrift {
  0%, 100% { opacity: 0.5; transform: translateY(0); }
  50% { opacity: 0.8; transform: translateY(-10px); }
}

/* ── Board Glow Border ── */
#game-board {
  box-shadow: 
    0 0 20px rgba(168,85,247,0.1),
    0 0 40px rgba(168,85,247,0.05),
    inset 0 0 30px rgba(0,0,0,0.2) !important;
  border: 1px solid rgba(168,85,247,0.15) !important;
}

/* ── Cell Hover 3D ── */
.grid-cell {
  transition: transform 0.1s ease, box-shadow 0.1s ease !important;
  transform-style: preserve-3d !important;
}

.grid-cell:active {
  transform: translateZ(-2px) scale(0.95) !important;
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.3) !important;
}

/* ── Gem Selected Ring ── */
.grid-cell.selected .gem {
  animation: selectedBounce 0.8s ease-in-out infinite !important;
  filter: drop-shadow(0 0 12px rgba(255,255,255,0.6)) brightness(1.2) !important;
}

@keyframes selectedBounce {
  0%, 100% { transform: scale(1) translateZ(4px); }
  50% { transform: scale(1.1) translateZ(8px); }
}

/* ── Boss Fight Overlay ── */
.boss-fight-active #game-board {
  border-color: rgba(239,68,68,0.3) !important;
  box-shadow: 
    0 0 30px rgba(239,68,68,0.15),
    0 0 60px rgba(239,68,68,0.05),
    inset 0 0 30px rgba(239,68,68,0.05) !important;
}

/* ── Power-up Activation Flash ── */
@keyframes powerFlash {
  0% { background: rgba(255,255,255,0); }
  20% { background: rgba(255,255,255,0.15); }
  100% { background: rgba(255,255,255,0); }
}

.power-flash {
  animation: powerFlash 0.4s ease-out !important;
}

/* ── Loading Screen 3D ── */
#loading-screen .game-logo {
  transform-style: preserve-3d;
  animation: logoFloat 3s ease-in-out infinite;
}

@keyframes logoFloat {
  0%, 100% { transform: translateY(0) rotateX(0); }
  25% { transform: translateY(-8px) rotateX(2deg); }
  75% { transform: translateY(4px) rotateX(-1deg); }
}

/* ── Menu Card Hover 3D ── */
.menu-btn, .mode-card {
  transform-style: preserve-3d !important;
  transition: transform 0.2s ease, box-shadow 0.2s ease !important;
}

.menu-btn:active, .mode-card:active {
  transform: scale(0.96) translateZ(-4px) !important;
}

/* ── Match Ring Shockwave ── */
.match-ring {
  position: absolute;
  inset: -10px;
  border: 2px solid rgba(255,255,255,0.6);
  border-radius: 50%;
  pointer-events: none;
  animation: matchRingExpand 0.4s ease-out forwards;
  z-index: 10;
}

@keyframes matchRingExpand {
  0% {
    transform: scale(0.3);
    opacity: 1;
    border-width: 3px;
  }
  100% {
    transform: scale(2.5);
    opacity: 0;
    border-width: 0.5px;
  }
}

/* ── Combo Screen Flash Overlay ── */
.combo-screen-flash {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
  animation: comboFlash 0.4s ease-out forwards;
}

@keyframes comboFlash {
  0% { opacity: 0.25; }
  100% { opacity: 0; }
}

/* ── Enhanced Cell Flash ── */
@keyframes cell-flash {
  0% {
    background: rgba(255,255,255,0);
    transform: scale(1);
  }
  30% {
    background: rgba(255,255,255,0.8);
    transform: scale(1.15);
  }
  100% {
    background: rgba(255,255,255,0);
    transform: scale(0.8);
  }
}

/* ── Gem Match Dissolve ── */
.cell .gem.matching {
  animation: gemDissolve 0.2s ease-out forwards !important;
}

@keyframes gemDissolve {
  0% {
    transform: scale(1) rotate(0);
    opacity: 1;
    filter: brightness(1);
  }
  40% {
    transform: scale(1.3) rotate(5deg);
    filter: brightness(2);
  }
  100% {
    transform: scale(0) rotate(15deg);
    opacity: 0;
    filter: brightness(3);
  }
}

/* ── New Gem Drop Bounce (enhanced) ── */
.cell .gem.dropping {
  animation: gemDropBounce3D 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important;
}

@keyframes gemDropBounce3D {
  0% {
    transform: translateY(-60px) scale(0.7) translateZ(20px);
    opacity: 0.5;
  }
  60% {
    transform: translateY(4px) scale(1.05) translateZ(-2px);
    opacity: 1;
  }
  80% {
    transform: translateY(-2px) scale(0.98);
  }
  100% {
    transform: translateY(0) scale(1) translateZ(0);
    opacity: 1;
  }
}

/* ── Special Gem Creation Flash ── */
@keyframes specialCreate {
  0% {
    transform: scale(0) rotate(-180deg);
    opacity: 0;
    filter: brightness(3) saturate(2);
  }
  50% {
    transform: scale(1.4) rotate(0);
    opacity: 1;
    filter: brightness(2) saturate(1.5);
  }
  100% {
    transform: scale(1) rotate(0);
    opacity: 1;
    filter: brightness(1) saturate(1);
  }
}

.gem.special-create {
  animation: specialCreate 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
}

/* ── Score Popup Float (enhanced) ── */
.score-popup {
  animation: scoreFloat3D 0.7s ease-out forwards !important;
  text-shadow: 0 0 10px currentColor, 0 2px 4px rgba(0,0,0,0.5) !important;
}

@keyframes scoreFloat3D {
  0% {
    transform: translate(-50%, -50%) scale(0.5) translateZ(10px);
    opacity: 1;
  }
  50% {
    transform: translate(-50%, -80%) scale(1.2) translateZ(20px);
    opacity: 0.9;
  }
  100% {
    transform: translate(-50%, -120%) scale(0.8) translateZ(0);
    opacity: 0;
  }
}

/* ── Combo Display Premium ── */
#combo-display {
  text-shadow: 0 0 30px currentColor, 0 0 60px currentColor, 0 4px 8px rgba(0,0,0,0.8) !important;
  filter: drop-shadow(0 0 20px currentColor) !important;
}

@keyframes combo-pop {
  0% {
    transform: scale(0.3) rotate(-10deg) translateZ(30px);
    opacity: 0;
  }
  40% {
    transform: scale(var(--combo-scale, 1.3)) rotate(0) translateZ(10px);
    opacity: 1;
  }
  70% {
    transform: scale(calc(var(--combo-scale, 1.3) * 0.9)) rotate(2deg);
  }
  100% {
    transform: scale(0.6) translateY(-40px);
    opacity: 0;
  }
}

/* ── Rainbow Gem Shimmer ── */
.gem[data-special="rainbow"],
.gem.rainbow {
  animation: rainbowShimmer 2s linear infinite !important;
  filter: saturate(1.5) brightness(1.1) !important;
}

@keyframes rainbowShimmer {
  0%   { filter: hue-rotate(0deg) saturate(1.5) brightness(1.1); }
  50%  { filter: hue-rotate(180deg) saturate(2) brightness(1.3); }
  100% { filter: hue-rotate(360deg) saturate(1.5) brightness(1.1); }
}

/* ── Line Blast Laser ── */
.line-blast-h, .line-blast-v {
  position: absolute;
  pointer-events: none;
  z-index: 50;
  animation: laserBlast 0.4s ease-out forwards;
}

.line-blast-h {
  left: 0; right: 0;
  height: 4px;
  top: 50%;
  margin-top: -2px;
  background: linear-gradient(90deg, transparent, #fff, rgba(59,130,246,0.8), #fff, transparent);
  box-shadow: 0 0 15px rgba(59,130,246,0.6), 0 0 30px rgba(59,130,246,0.3);
}

.line-blast-v {
  top: 0; bottom: 0;
  width: 4px;
  left: 50%;
  margin-left: -2px;
  background: linear-gradient(180deg, transparent, #fff, rgba(239,68,68,0.8), #fff, transparent);
  box-shadow: 0 0 15px rgba(239,68,68,0.6), 0 0 30px rgba(239,68,68,0.3);
}

@keyframes laserBlast {
  0% { opacity: 0; transform: scaleX(0.3); }
  20% { opacity: 1; transform: scaleX(1); }
  100% { opacity: 0; }
}

/* ── Bomb Explosion Ripple ── */
.bomb-ripple {
  position: absolute;
  inset: -30px;
  border: 3px solid rgba(255,165,0,0.8);
  border-radius: 50%;
  pointer-events: none;
  z-index: 50;
  animation: bombRipple 0.5s ease-out forwards;
}

@keyframes bombRipple {
  0% {
    transform: scale(0.2);
    opacity: 1;
    border-width: 6px;
    box-shadow: 0 0 30px rgba(255,165,0,0.6);
  }
  100% {
    transform: scale(4);
    opacity: 0;
    border-width: 0.5px;
    box-shadow: none;
  }
}
